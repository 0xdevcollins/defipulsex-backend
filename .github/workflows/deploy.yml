name: ðŸš€ Deploy Gridape API on Push

on:
  push:
    branches:
      - main

jobs:
  web-deploy:
    name: ðŸŽ‰ Deploy
    runs-on: ubuntu-latest
    steps:
      - name: ðŸšš Get latest code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ðŸ” Prepare changed files for deployment
        id: changed-files
        run: |
          # Debug: Print current directory
          echo "Current directory: $(pwd)"

          # Get and display list of changed files
          CHANGED_FILES=$(git diff --diff-filter=ACMRT --name-only HEAD^ HEAD)
          echo "Files that changed:"
          echo "$CHANGED_FILES"

          if [ -z "$CHANGED_FILES" ]; then
            echo "No files changed"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Create directory for changed files
          mkdir -p changed_files

          # Copy each changed file while maintaining structure
          while IFS= read -r file; do
            if [ -n "$file" ] && [ -f "$file" ]; then
              echo "Processing file: $file"
              target_dir="changed_files/$(dirname "$file")"
              mkdir -p "$target_dir"
              cp "$file" "changed_files/$file"
              echo "Copied $file to changed_files/$file"
            fi
          done <<< "$CHANGED_FILES"

          # Verify files were copied
          if [ -d "changed_files" ] && [ "$(ls -A changed_files)" ]; then
            echo "Files were successfully copied to changed_files directory"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "No files were copied to changed_files directory"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

          # List contents recursively
          echo "Contents of changed_files directory (recursive):"
          find changed_files -type f

      - name: ðŸ“‚ Sync changed files
        if: steps.changed-files.outputs.has_changes == 'true'
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server: 46.202.195.31
          username: defipulsexapi
          password: FEypqGWLlo52tDzxxhJN
          local_path: './changed_files/'  # Changed this to use directory without glob
          remote_path: '/home/defipulsexapi/htdocs/www.api.defipulsex.org'
          exclude: |
            **/.env
            **/.git*
            **/.git*/**
            **/node_modules/**
            .github
            **/vendor/**

      - name: ðŸš€ Deployment status
        if: always()
        run: |
          if [ "${{ steps.changed-files.outputs.has_changes }}" == "true" ]; then
            echo "Deployment completed with files"
          else
            echo "No files to deploy"
          fi
